const express  =  require('express');

const router  =  express.Router();

const Util = require('../helpers/Util.helper');

const Merchants = require('../models/merchants.model');

const Terminals = require('../models/terminals.model');

const fetch = require('node-fetch');

require('dotenv').config();

router.post('/add-ids',async (req,res)=>{
    try {
        //add to model (164)
        let MerchantID = {
			"2050CZ92": "153072345", 
			"2050CT56": "153072345",
			"20560EG29": "600466032",
			"2050EG28": "600466032",
			"2050EG39": "600466032",
			"2050EG18": "600466032",
			"2050EG26": "600466032",
			"2050EG16": "600466032",
			"2050EG27": "600466032",
			"2050EG37": "600466032",
			"2050EG24": "600466032",
			"2050EG17": "600466032",
			"2050EG22": "600466032",
			"2050EG25": "600466032",
			"2050EG23": "600466032",
			"2050EG35": "600466032",
			"2050EG38": "600466032",
			"2050EG19": "600466032",
			"2050EG40": "600466032",
			"2050EG30": "600466032",
			"2050EG36": "600466032",
			"2050M276": "427736555",
			"2050EH77": "365722763",
			"2050EH78": "365722763",
			"2050EH79": "365722763",
			"2050EH80": "365722763",
			"2050EH81": "365722763",
			"2050EH82": "365722763",
			"2050EH59": "365722763",
			"2050CT61": "426601080",
			"2050EJ49": "882405540",
			"2050EK08": "556541885",
			"2050EG29": "600466032",
			"2050EG21": "600466032",
			"2050M276": "20027933",
			"2050EH78": "365722763",
			"2050EJ06": "20012997",
			"2050EJ11": "868641120",
			"2050EH78": "365722763",
			"2050EK31": "427736555",
			"2050EH13": "277556434",
			"2050EH14": "277556434",
			"2050J328": "20011005",
			"2050EH77": "365722763",
			"2050EH77": "365722763",
			"2050EG29": "600466032",
			"2050EG21": "600466032",
			"2050M276": "20027933",
			"2050EH78": "365722763",
			"2050C665": "043251301",
			"2050EM49": "20011294",
			"2050EM50": "20011294",
			"2050EM51": "20011294",
			"2050EM52": "20011294",
			"2050EM53": "20011294",
			"2050EM54": "20011294",
			"2050EM55": "20011294",
			"2050EM56": "20011294",
			"2050EM57": "20011294",
			"2050EM58": "20011294",
			"2050EM59": "20011294",
			"2050EM60": "20011294",
			"2050EM61": "20011294",
			"2050EM62": "20011294",
			"2050EM63": "20011294",
			"2050EM64": "20011294",
			"2050EM65": "20011294",
			"2050EM66": "20011294",
			"2050EM67": "20011294",
			"2050EM68": "20011294",
			"2050EJ06": "20012997",
			"2050EH86": "635265133",
			"2050EH87": "647723878",
			"2050EH88": "545028056",
			"2050EH89": "545028056",
			"2050EH15": "685410028",
			"2050EH16": "023747564",
			"2050EJ33": "20026417",
			"2050EO98": "678517870",
			"2050EQ00": "625243563",
			"2050EQ01": "625243563",

			"2050ER87": "856312323",
			"2050ER88": "765730676",
			"2050EH71": "873062613",
			"2050EL56": "20010496",
			"2050EL57": "20010496",
			"2050EL58": "20010496",
			"2050EL59": "20010496",
			"2050EL60": "20010496",
			"2050EH82": "365722763",
			"2050EH80": "365722763",
			"2050EH81": "365722763",
			"2050EH77": "365722763",
			"2050EQ00": "625243563",
			"2050EQ01": "625243563",

			// 2019-07-02 
			"2050EJ12": "247702364",
			"2050EJ06": "20012997",
			"2050EK31": "427736555",
			"2050ER41": "444710206",
			"2050C948": "20013185",
			"2050ET04": "456161518",
			"2050ET05": "456161518",
			"2050ET06": "456161518",
			"2050ET07": "456161518",
			"2050ET08": "456161518",
			"2050ET09": "456161518",
			"2050ET10": "456161518",
			"2050ET11": "456161518",
			"2050ET12": "456161518",
			"2050ET13": "456161518",
			"2050ET14": "456161518",
			"2050ET15": "456161518",
			"2050ET16": "456161518",
			"2050ET17": "456161518",
			"2050ET18": "456161518",
			"2050ET19": "456161518",
			"2050ET20": "456161518",
			"2050ET21": "456161518",
			"2050ET22": "456161518",
			"2050ET23": "456161518",
			"2050ET24": "456161518",
			"2050ET25": "456161518",
			"2050ET26": "456161518",
			"2050ET27": "456161518",
			"2050ET28": "456161518",
			
			//26-08-2019
			"2050FC33": "427703801",
			"2050FC34": "427703801",

			//17-09-2019
			"2050EU96": "276360326",

			"2050FE58": "652107356",

			"2050BJ93": "20035003",

			"2050EV01": "147144080",
			"2050EV01": "147144080",

			//01-11-2019

			"2050FE49": "652107356",
			"2050FE52": "652107356",

			"2050FE48": "652107356",
			"2050FE50": "652107356",

			"2050FE57": "652107356",
			"2050FE54": "652107356",

			"2050FE51": "652107356",
			"2050FE47": "652107356",

			"2050FE55": "652107356",
			"2050FE56": "652107356",

			"2050FE58": "652107356",
			"2050FE33": "652107356",

			"2050CZ50": "630517875",

			"2050FE58": "652107356",

			"2050M433": "20012531",

			// 06-12-2019
			"2050CQ08": "378084610",
			"2050CZ46": "630517875",

			"2050FT83": "585434680",
			"2050FT84": "585434680",

			//13-01-20
			"2050FW45": "877525435",
			"2050FW46": "877525435",

			//16-01-2020
			"2050FJ75": "746755475",

			//03/02/2020
			"2050P537": "20010830",

			//12-02-2020
			"2050DY45": "426601080",

			"2050EK31": "20027933",

			"2050EX92": "411547768",
			"2050EX93": "411547768",
			"2050EX94": "411547768",

			"2050ER41": "444710206",
			"20013952": "20013952",
			"2050GC42": "455655766",

			// // 06-06-2020
			"2050FN77": "456161518",
			"2050FN78": "456161518",
			"2050FN79": "456161518",
			"2050FN80": "456161518",
			"2050FN81": "456161518",
			"2050FN82": "456161518",
			"2050FN83": "456161518",
			"2050FN84": "456161518",
			"2050FN85": "456161518",
			"2050FN86": "456161518",
			"2050FN87": "456161518",
			"2050FN88": "456161518",
			"2050FN89": "456161518",
			"2050FN90": "456161518",
			"2050FN91": "456161518",
			"2050FN92": "456161518",
			"2050FN93": "456161518",
			"2050FN94": "456161518",
			"2050FN95": "456161518",
			"2050FN96": "456161518",

			"2050AS52": "20013605",

			"2050M628": "427736555",

			"2050GF64": "817376375",

			"2050DM30": "400678446"
        };

        let TerminalID = {
			"2050CZ92": "20208008", 
			"2050CT56": "20208008",
			"20560EG29": "20203383",
			"2050EG28": "20203384",
			"2050EG39": "20203391",
			"2050EG18": "20203392",
			"2050EG26": "20203393",
			"2050EG16": "20203395",
			"2050EG27": "20203396",
			"2050EG37": "20203397",
			"2050EG24": "20203398",
			"2050EG17": "20203399",
			"2050EG22": "20203400",
			"2050EG25": "20203401",
			"2050EG23": "20203406",
			"2050EG35": "20203385",
			"2050EG38": "20203407",
			"2050EG19": "20203271",
			"2050EG40": "20203387",
			"2050EG30": "20203388",
			"2050EG36": "20203402",
			"2050M276": "20209629",
			"2050EG21": "20203402",
			"2050EG36": "20203390",
			"2050EH77": "365722763",
			"2050EH78": "365722763",
			"2050EH79": "365722763",
			"2050EH80": "365722763",
			"2050EH81": "365722763",
			"2050EH82": "365722763",
			"2050EH59": "365722763",
			"2050CT61": "20171921",
			"2050EJ49": "20220710",
			"2050EK08": "20221352",
			"2050EG29": "20203383",
			"2050EG21": "20203402",
			"2050M276": "20027933",
			"2050EH78": "20505224",
			"2050EJ06": "20221129",
			"2050EJ11": "20221107",
			"2050EH78": "20205224",
			"2050EK31": "20209629",
			"2050EH13": "20209450",
			"2050EH14": "20209451",
			"2050J328": "20011005",
			"2050EH77": "20205230",
			"2050EH77": "20205230",
			"2050EG29": "20203383",
			"2050EG21": "20203402",
			"2050M276": "20027933",
			"2050EH78": "20505224",
			"2050C665": "20023280",
			"2050EM49": "20024807",
			"2050EM50": "20024808",
			"2050EM51": "20024816",
			"2050EM52": "20024828",
			"2050EM53": "20024829",
			"2050EM54": "20024809",
			"2050EM55": "20024810",
			"2050EM56": "20024811",
			"2050EM57": "20024812",
			"2050EM58": "20024813",
			"2050EM59": "20024814",
			"2050EM60": "20024815",
			"2050EM61": "20024817",
			"2050EM62": "20024818",
			"2050EM63": "20024819",
			"2050EM64": "20024820",
			"2050EM65": "20024822",
			"2050EM66": "20024823",
			"2050EM67": "20024826",
			"2050EM68": "20024827",
			"2050EJ06": "20221129",
			"2050EH86": "20021614",
			"2050EH87": "20021436",
			"2050EH88": "20021469",
			"2050EH89": "20021469",
			"2050EH15": "20011554",
			"2050EH16": "20021423",
			"2050EJ33": "20026417",
			"2050EO98": "20022852",
			"2050EQ00": "20026789",
			"2050EQ01": "20019486",

			"2050ER87": "20021615",
			"2050ER88": "20021442",
			"2050EH71": "20065058",
			"2050EL56": "20115824",
			"2050EL57": "20010496",
			"2050EL58": "20031257",
			"2050EL59": "20031264",
			"2050EL60": "20031273",
			"2050EH82": "20011973",
			"2050EH80": "20011980",
			"2050EH81": "20011978",
			"2050EH77": "20011963",
			"2050EQ00": "20026789",
			"2050EQ01": "20019486",

			// 2019-07-02 
			"2050EJ12": "20036040",
			"2050EJ06": "20026781",
			"2050EK31": "20209629",
			"2050ER41": "20133590",
			"2050C948": "20013185",
			"2050ET04": "20039461",
			"2050ET05": "20039473",
			"2050ET06": "20039480",
			"2050ET07": "20039529",
			"2050ET08": "20039529",
			"2050ET09": "20039390",
			"2050ET10": "20039393",
			"2050ET11": "20039395",
			"2050ET12": "20039407",
			"2050ET13": "20039408",
			"2050ET14": "20039385",
			"2050ET15": "20039388",
			"2050ET16": "20039396",
			"2050ET17": "20039397",
			"2050ET18": "20039400",
			"2050ET19": "20039401",
			"2050ET20": "20039402",
			"2050ET21": "20039405",
			"2050ET22": "20039406",
			"2050ET23": "20039448",
			"2050ET24": "20039525",
			"2050ET25": "20039530",
			"2050ET26": "20039531",
			"2050ET27": "20039534",
			"2050ET28": "20038676",
			
			//26-08-2019
			"2050FC33": "20053082",
			"2050FC34": "20053082",

			//17-09-2019
			"2050EU96": "20042711",

			"2050FE58": "20108288",
			"2050BJ93": "20094013",

			"2050EV01": "20019908",
			"2050EV01": "20011308",

			//01-11-2019

			"2050FE49": "20135931",
			"2050FE52": "20135931",

			"2050FE48": "20135931",
			"2050FE50": "20135921",

			"2050FE57": "20135925",
			"2050FE54": "20135925",

			"2050FE51": "20135928",
			"2050FE47": "20135928",

			"2050FE55": "20135929",
			"2050FE56": "20135929",

			"2050FE58": "20135937",
			"2050FE33": "20135937",

			"2050CZ50": "20184290",

			"2050FE58": "20111134",

			"2050M433": "20117495",

			// 06-12-2019
			"2050CQ08": "20184296",
			"2050CZ46": "20126479",

			"2050FT83": "20135578",
			"2050FT84": "20135578",

			//13-01-20
			"2050FW45": "20128835",
			"2050FW46": "20128785",

			//16-01-2020
			"2050FJ75": "20208396",

			"2050P537": "20010830",

			//12-02-2020
			"2050DY45": "20171921",

			"2050EK31": "20027933",

			"2050EX92": "20046268",
			"2050EX93": "20046268",
			"2050EX94": "20046270",

			"2050ER41": "20133592",
			"2050BI62": "20013952",
			"2050GC42": "20202701",

			// 06-06-2020
			"2050FN77": "20096837",
			"2050FN78": "20128540",
			"2050FN79": "20072637",
			"2050FN80": "20086214",
			"2050FN81": "20199328",
			"2050FN82": "20139512",
			"2050FN83": "20181426",
			"2050FN84": "20079354",
			"2050FN85": "20034830",
			"2050FN86": "20162866",
			"2050FN87": "20071600",
			"2050FN88": "20151075",
			"2050FN89": "20077207",
			"2050FN90": "20103434",
			"2050FN91": "20182093",
			"2050FN92": "20168967",
			"2050FN93": "20137293",
			"2050FN94": "20091264",
			"2050FN95": "20168298",
			"2050FN96": "20036965",

			"2050AS52": "20120110",

			"2050M628": "20209629",

			"2050GF64": "20100351",

			"2050DM30": "20039191"
        };

        return res.json({
            status: true,
            message: 'success',
            data: MerchantID,
            total: 'TerminalIDs ' + Object.keys(TerminalID).length
        });
    }catch (error) {
        console.log(error);

        return res.status(500).json(
            "an error has occurred"
        )
    }
});

router.post('/all',async (req,res)=>{
    let merc = await Terminals.find();

    return res.status(200).json({
        terminals: merc
    });
});

router.post('/find',async (req,res)=>{
    try {
        console.log(req.body.mercKey);
        
        let merchantKey = req.body.mercKey;

        console.log(Util.hasWhiteSpace(merchantKey));

		//getTerminal
		let terminalID = await Util.findTerminal(merchantKey);
		var merchant_idd = terminalID || null;
		console.log("key", merchant_idd);

        return res.status(200).json({
            key: 'key-' + req.body.mercKey,
			data: merchant_idd[0].Merchanridd
        })
    }catch (error) {
        console.log(error);

        return res.status(500).json(
            "an error has occurred"
        )
    }
});

router.post('/process',async (req,res)=>{
    try {
		
		if (Util.getData.mode === "live"){
			Util.getData.sessionId = process.env.LIVE_SESSION_ID;
			Util.getData.requestUrl = process.env.LIVE_REQUESTURL;
			Util.getData.overwriteTerminalID = process.env.LIVE_TERMINALID;
			Util.getData.overwriteMerchantID = process.env.LIVE_MERCHANTID;
		}

		let serviceLimit = Util.serviceLimit();

		if (serviceLimit !== true){
			return res.json(serviceLimit);
		}

		let response = {
			status: 0,
			message: "An error occured",
			description: "There was an unknown error"
		};

		let theRequest = req.body;
		console.log("Payload", theRequest);

		if (!theRequest.posTerminalId){
			let error = {
				error: true,
				message: "Please provide parameter(s)"
			};

			return res.status(400).json(error);
		}

		if (theRequest !== null){
			let posTerminalID = theRequest.posTerminalId;
			console.log(posTerminalID, "Received QR POS Terminal ID: \n" + posTerminalID + "\n" + theRequest);

			let requestData = {};
			let getMerchantId = Util.findMerchant(posTerminalID);

			if (Util.isset(posTerminalID) && Util.isset(getMerchantId) && (getMerchantId==null)){
				//getMerchantId.isEmpty()
				
				requestData.merchantID = getMerchantId;
				requestData.terminalID = Util.findTerminal(posTerminalID);
				requestData.posTerminalID = posTerminalID;
			}else{

				requestData.merchantID ="0000";
				requestData.terminalID = "0000";
				requestData.posTerminalID = "0000";
			}
			
			requestData.sessionID = process.env.LIVE_SESSION_ID;//Util.getData.sessionID
			requestData.transactionFilter = 20;

			let requestPostField = requestData;
			let requestUrl = Util.getData.requestUrl;

			// console.log("QR Request Post Field: " . JSON.stringify(requestPostField));
			console.log("requestPayload", requestPostField);

			fetch(requestUrl, {
				method: 'post',
				body:    JSON.stringify(requestPostField),
				headers: { 'Content-Type': 'application/json' },
			})
			.then((json) => {
				console.log("Ecobank QR Response: ", json);
				return res.json(json);
			})
			.catch((err) =>{
				console.log(err);
				return err;
			});

			//await the connection to the endpoint
		}

		// return res.json({status: true, message: 'Ecobank QR Processing...'});

    }catch (error) {
        console.log(error);

        return res.status(500).json(
            Response(true,"an error has occurred")
        )
    }
});

module.exports = router;